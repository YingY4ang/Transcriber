{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ConsultationArtifact",
  "description": "Complete structured output from single Bedrock AI pass - supports all medical contexts",
  "type": "object",
  "required": ["version", "metadata", "soap_notes", "follow_up_tasks"],
  "properties": {
    "version": {
      "type": "string",
      "const": "2.0",
      "description": "Schema version for compatibility"
    },
    
    "metadata": {
      "type": "object",
      "required": ["consultation_id", "timestamp", "setting_type"],
      "properties": {
        "consultation_id": {
          "type": "string",
          "description": "Unique identifier (matches audio_key)"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of consultation"
        },
        "duration_seconds": {
          "type": "number",
          "description": "Consultation duration if determinable"
        },
        "setting_type": {
          "type": "string",
          "enum": ["clinic", "hospital_inpatient", "hospital_outpatient", "emergency_department", "telehealth", "home_visit", "nursing_home", "other"]
        },
        "specialty": {
          "type": "string",
          "description": "Medical specialty context",
          "examples": ["general_practice", "internal_medicine", "surgery", "pediatrics", "emergency_medicine", "nursing"]
        },
        "encounter_type": {
          "type": "string",
          "enum": ["initial_consultation", "follow_up", "ward_round", "admission", "discharge", "handover", "procedure", "emergency"]
        },
        "participants": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "role": {
                "type": "string",
                "enum": ["doctor", "nurse", "patient", "family", "specialist", "student", "other"]
              },
              "identifier": {
                "type": "string",
                "description": "De-identified placeholder or role description"
              }
            }
          }
        },
        "location": {
          "type": "object",
          "properties": {
            "facility": {"type": "string"},
            "ward": {"type": "string"},
            "room": {"type": "string"},
            "bed": {"type": "string"}
          }
        }
      }
    },
    
    "patient_context": {
      "type": "object",
      "description": "De-identified patient information",
      "properties": {
        "patient_identifier": {
          "type": "string",
          "description": "De-identified placeholder (e.g., 'Patient A', 'NHI-REDACTED')"
        },
        "age_range": {
          "type": "string",
          "description": "Age bracket for context",
          "examples": ["0-1", "1-5", "5-12", "12-18", "18-40", "40-65", "65+"]
        },
        "gender": {
          "type": "string",
          "enum": ["male", "female", "other", "not_specified"]
        },
        "admission_date": {
          "type": "string",
          "format": "date",
          "description": "For inpatient contexts"
        },
        "hospital_day": {
          "type": "integer",
          "description": "Day number since admission"
        }
      }
    },
    
    "soap_notes": {
      "type": "object",
      "required": ["subjective", "objective", "assessment", "plan"],
      "properties": {
        "subjective": {
          "type": "object",
          "properties": {
            "chief_complaint": {
              "type": "string",
              "description": "Primary reason for consultation in patient's words"
            },
            "history_of_presenting_complaint": {
              "type": "string",
              "description": "Detailed narrative of current issue"
            },
            "symptoms": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "symptom": {"type": "string"},
                  "onset": {"type": "string"},
                  "duration": {"type": "string"},
                  "severity": {
                    "type": "string",
                    "enum": ["mild", "moderate", "severe", "not_specified"]
                  },
                  "characteristics": {"type": "string"},
                  "aggravating_factors": {"type": "array", "items": {"type": "string"}},
                  "relieving_factors": {"type": "array", "items": {"type": "string"}},
                  "associated_symptoms": {"type": "array", "items": {"type": "string"}},
                  "transcript_evidence": {
                    "type": "string",
                    "description": "Quote or timestamp from transcript"
                  }
                }
              }
            },
            "past_medical_history": {
              "type": "array",
              "items": {"type": "string"}
            },
            "current_medications": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "medication": {"type": "string"},
                  "dose": {"type": "string"},
                  "frequency": {"type": "string"},
                  "indication": {"type": "string"}
                }
              }
            },
            "allergies": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "allergen": {"type": "string"},
                  "reaction": {"type": "string"},
                  "severity": {"type": "string"}
                }
              }
            },
            "social_history": {
              "type": "object",
              "properties": {
                "smoking": {"type": "string"},
                "alcohol": {"type": "string"},
                "recreational_drugs": {"type": "string"},
                "occupation": {"type": "string"},
                "living_situation": {"type": "string"},
                "support_network": {"type": "string"}
              }
            },
            "family_history": {
              "type": "array",
              "items": {"type": "string"}
            },
            "functional_status": {
              "type": "object",
              "properties": {
                "mobility": {"type": "string"},
                "adls": {"type": "string", "description": "Activities of daily living"},
                "cognitive_status": {"type": "string"}
              }
            },
            "review_of_systems": {
              "type": "object",
              "description": "Systematic review by body system",
              "additionalProperties": {"type": "string"}
            }
          }
        },
        
        "objective": {
          "type": "object",
          "properties": {
            "vital_signs": {
              "type": "object",
              "properties": {
                "blood_pressure": {"type": "string"},
                "heart_rate": {"type": "string"},
                "respiratory_rate": {"type": "string"},
                "temperature": {"type": "string"},
                "oxygen_saturation": {"type": "string"},
                "weight": {"type": "string"},
                "height": {"type": "string"},
                "bmi": {"type": "string"},
                "pain_score": {"type": "string"},
                "gcs": {"type": "string", "description": "Glasgow Coma Scale"},
                "avpu": {"type": "string", "description": "Alert/Voice/Pain/Unresponsive"},
                "timestamp": {"type": "string"}
              }
            },
            "physical_examination": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "system": {
                    "type": "string",
                    "examples": ["general", "cardiovascular", "respiratory", "abdominal", "neurological", "musculoskeletal", "skin", "ent", "psychiatric"]
                  },
                  "findings": {"type": "string"},
                  "abnormalities": {"type": "array", "items": {"type": "string"}}
                }
              }
            },
            "investigations": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "test_type": {"type": "string"},
                  "test_name": {"type": "string"},
                  "result": {"type": "string"},
                  "date": {"type": "string"},
                  "interpretation": {"type": "string"},
                  "reference_range": {"type": "string"}
                }
              }
            },
            "imaging_results": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "modality": {"type": "string"},
                  "body_part": {"type": "string"},
                  "findings": {"type": "string"},
                  "date": {"type": "string"}
                }
              }
            },
            "lines_and_devices": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "device_type": {"type": "string", "examples": ["IV", "catheter", "drain", "NGT", "oxygen", "monitor"]},
                  "location": {"type": "string"},
                  "inserted_date": {"type": "string"},
                  "functioning": {"type": "boolean"}
                }
              }
            },
            "fluid_balance": {
              "type": "object",
              "properties": {
                "input_24h": {"type": "string"},
                "output_24h": {"type": "string"},
                "balance": {"type": "string"}
              }
            }
          }
        },
        
        "assessment": {
          "type": "object",
          "properties": {
            "primary_diagnosis": {
              "type": "string",
              "description": "Main working diagnosis"
            },
            "differential_diagnoses": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "diagnosis": {"type": "string"},
                  "likelihood": {"type": "string", "enum": ["high", "moderate", "low"]},
                  "reasoning": {"type": "string"}
                }
              }
            },
            "problem_list": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "problem": {"type": "string"},
                  "status": {"type": "string", "enum": ["active", "improving", "resolved", "chronic", "new"]},
                  "priority": {"type": "integer"},
                  "onset_date": {"type": "string"}
                }
              }
            },
            "clinical_impression": {
              "type": "string",
              "description": "Overall clinical assessment and reasoning"
            },
            "severity_assessment": {
              "type": "string",
              "enum": ["stable", "improving", "deteriorating", "critical", "not_assessed"]
            },
            "prognosis": {
              "type": "string"
            }
          }
        },
        
        "plan": {
          "type": "object",
          "properties": {
            "treatment_plan": {
              "type": "string",
              "description": "Overall treatment strategy"
            },
            "medications_prescribed": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "medication": {"type": "string"},
                  "dose": {"type": "string"},
                  "route": {"type": "string"},
                  "frequency": {"type": "string"},
                  "duration": {"type": "string"},
                  "indication": {"type": "string"},
                  "special_instructions": {"type": "string"}
                }
              }
            },
            "investigations_ordered": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "test_type": {"type": "string"},
                  "test_name": {"type": "string"},
                  "urgency": {"type": "string", "enum": ["stat", "urgent", "routine"]},
                  "indication": {"type": "string"}
                }
              }
            },
            "referrals": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "specialty": {"type": "string"},
                  "urgency": {"type": "string", "enum": ["stat", "urgent", "routine"]},
                  "reason": {"type": "string"}
                }
              }
            },
            "patient_education": {
              "type": "array",
              "items": {"type": "string"}
            },
            "follow_up": {
              "type": "object",
              "properties": {
                "required": {"type": "boolean"},
                "timeframe": {"type": "string"},
                "reason": {"type": "string"},
                "with_whom": {"type": "string"}
              }
            },
            "safety_netting": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Red flags and when to seek urgent care"
            },
            "escalation_criteria": {
              "type": "array",
              "items": {"type": "string"},
              "description": "When to escalate care or call for help"
            },
            "discharge_planning": {
              "type": "object",
              "properties": {
                "ready_for_discharge": {"type": "boolean"},
                "estimated_discharge_date": {"type": "string", "format": "date"},
                "estimated_discharge_time": {"type": "string"},
                "discharge_destination": {"type": "string"},
                "discharge_criteria": {"type": "array", "items": {"type": "string"}},
                "discharge_medications": {"type": "array", "items": {"type": "string"}},
                "discharge_equipment": {"type": "array", "items": {"type": "string"}},
                "home_services_required": {"type": "array", "items": {"type": "string"}},
                "follow_up_appointments": {"type": "array", "items": {"type": "string"}}
              }
            }
          }
        }
      }
    },
    
    "clinical_safety": {
      "type": "object",
      "properties": {
        "red_flags": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "flag": {"type": "string"},
              "severity": {"type": "string", "enum": ["critical", "high", "moderate"]},
              "action_taken": {"type": "string"}
            }
          }
        },
        "risk_factors": {
          "type": "array",
          "items": {"type": "string"}
        },
        "contraindications": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "item": {"type": "string"},
              "contraindication": {"type": "string"}
            }
          }
        },
        "missing_information": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Critical information not available in transcript"
        },
        "clarifying_questions": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Questions that should be asked for complete assessment"
        },
        "confidence_level": {
          "type": "string",
          "enum": ["high", "moderate", "low"],
          "description": "Overall confidence in extraction accuracy"
        }
      }
    },
    
    "follow_up_tasks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["task_id", "task_type", "description", "owner_role", "urgency", "status"],
        "properties": {
          "task_id": {
            "type": "string",
            "description": "Unique task identifier (e.g., task-001)"
          },
          "task_type": {
            "type": "string",
            "enum": [
              "order_scan",
              "order_lab",
              "book_room",
              "nursing_observation",
              "prepare_discharge",
              "prescription",
              "referral",
              "follow_up_call",
              "patient_education",
              "admin",
              "procedure",
              "medication_administration",
              "wound_care",
              "physiotherapy",
              "occupational_therapy",
              "social_work",
              "other"
            ]
          },
          "description": {
            "type": "string",
            "description": "Human-readable task description"
          },
          "owner_role": {
            "type": "string",
            "enum": ["doctor", "nurse", "admin", "radiology", "pharmacy", "lab", "physiotherapy", "occupational_therapy", "social_work", "other"]
          },
          "urgency": {
            "type": "string",
            "enum": ["stat", "urgent", "routine", "low"]
          },
          "due_at": {
            "type": "string",
            "description": "ISO datetime or relative time (e.g., 'in 2 hours', 'tomorrow morning')"
          },
          "location": {
            "type": "object",
            "properties": {
              "ward": {"type": "string"},
              "room": {"type": "string"},
              "department": {"type": "string"}
            }
          },
          "dependencies": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Array of task_ids that must complete first"
          },
          "status": {
            "type": "string",
            "enum": ["proposed", "pending", "in_progress", "completed", "cancelled"],
            "default": "proposed"
          },
          "transcript_evidence": {
            "type": "string",
            "description": "Quote or timestamp from transcript supporting this task"
          },
          "required_inputs": {
            "type": "object",
            "description": "Structured data for automation",
            "properties": {
              "prescription": {
                "type": "object",
                "properties": {
                  "medication": {"type": "string"},
                  "dose": {"type": "string"},
                  "route": {"type": "string"},
                  "frequency": {"type": "string"},
                  "duration": {"type": "string"},
                  "repeats": {"type": "integer"},
                  "indication": {"type": "string"},
                  "special_instructions": {"type": "string"},
                  "contraindications_checked": {"type": "boolean"}
                }
              },
              "imaging": {
                "type": "object",
                "properties": {
                  "modality": {"type": "string"},
                  "body_part": {"type": "string"},
                  "contrast": {"type": "boolean"},
                  "clinical_question": {"type": "string"},
                  "urgency": {"type": "string"}
                }
              },
              "lab_test": {
                "type": "object",
                "properties": {
                  "test_name": {"type": "string"},
                  "sample_type": {"type": "string"},
                  "fasting_required": {"type": "boolean"},
                  "urgency": {"type": "string"}
                }
              },
              "nursing_observation": {
                "type": "object",
                "properties": {
                  "observation_type": {"type": "string"},
                  "frequency": {"type": "string"},
                  "duration": {"type": "string"},
                  "parameters": {"type": "array", "items": {"type": "string"}},
                  "escalation_criteria": {"type": "string"}
                }
              },
              "room_booking": {
                "type": "object",
                "properties": {
                  "room_type": {"type": "string"},
                  "duration_minutes": {"type": "integer"},
                  "equipment_needed": {"type": "array", "items": {"type": "string"}},
                  "staff_required": {"type": "array", "items": {"type": "string"}}
                }
              },
              "discharge": {
                "type": "object",
                "properties": {
                  "estimated_date": {"type": "string", "format": "date"},
                  "estimated_time": {"type": "string"},
                  "destination": {"type": "string"},
                  "transport_required": {"type": "boolean"},
                  "medications_to_prepare": {"type": "array", "items": {"type": "string"}},
                  "equipment_needed": {"type": "array", "items": {"type": "string"}},
                  "follow_up_appointments": {"type": "array", "items": {"type": "string"}},
                  "discharge_summary_required": {"type": "boolean"}
                }
              },
              "referral": {
                "type": "object",
                "properties": {
                  "specialty": {"type": "string"},
                  "urgency": {"type": "string"},
                  "reason": {"type": "string"},
                  "preferred_provider": {"type": "string"}
                }
              }
            }
          }
        }
      }
    },
    
    "handover": {
      "type": "object",
      "description": "Structured handover for nursing/medical staff",
      "properties": {
        "situation": {
          "type": "string",
          "description": "Current patient situation (SBAR format)"
        },
        "background": {
          "type": "string",
          "description": "Relevant background and history"
        },
        "assessment": {
          "type": "string",
          "description": "Current clinical assessment"
        },
        "recommendation": {
          "type": "string",
          "description": "Recommended actions and plan"
        },
        "active_issues": {
          "type": "array",
          "items": {"type": "string"}
        },
        "pending_tasks_summary": {
          "type": "string",
          "description": "Summary of outstanding tasks"
        },
        "escalation_criteria": {
          "type": "array",
          "items": {"type": "string"}
        },
        "next_review_time": {
          "type": "string"
        },
        "key_contacts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "role": {"type": "string"},
              "name": {"type": "string"},
              "contact": {"type": "string"}
            }
          }
        }
      }
    },
    
    "metadata_extraction": {
      "type": "object",
      "description": "Metadata about the extraction process",
      "properties": {
        "extraction_timestamp": {"type": "string", "format": "date-time"},
        "model_used": {"type": "string"},
        "transcript_length": {"type": "integer"},
        "processing_notes": {"type": "string"}
      }
    }
  }
}
